#!/bin/bash

# Define the target directory
TARGET_DIR="$HOME/.local/vids"

read -rep "Stream Key: " stream_key

# Find the highest number used in existing filenames
MAX_NUMBER=$(ls -1 "$TARGET_DIR"/*_vid.mkv 2>/dev/null | \
	awk -F'[_]' '{print $1}' | \
	awk -F/ '{print $NF}' | \
	sort -n | \
	tail -1)

# Check if no files were found
if [ -z "$MAX_NUMBER" ]; then
	MAX_NUMBER=0
fi

# Determine the next number
NEXT_NUMBER=$((MAX_NUMBER + 1))

# Define the filename format
FILENAME="$TARGET_DIR/${NEXT_NUMBER}_vid.mkv"

# Take the screenshot and save it with the new filename
sleep 2 &&
	ffmpeg -y \
	-f x11grab \
	-draw_mouse 0 \
	-s 1366x768 \
	-i :0.0 \
	-f alsa -i default \
	-c:v libx264 -r 30 -c:a flac \
	-f flv rtmp://a.rtmp.youtube.com/live2/$stream_key
	-c:v libx264 -r 30 -c:a flac "$FILENAME"
